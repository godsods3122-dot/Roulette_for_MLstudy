<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìŠ¤í„°ë”” ì—­í•  ë¶„ë‹´ ìŠ¬ë¡¯ ë¨¸ì‹ </title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getDatabase, ref, get, set, update, push, query, limitToLast } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyDLwzXcJw0dDuOR7F76MQvZQ9NoY2hH3bQ",
    authDomain: "roulette-data-4f5bf.firebaseapp.com",
    projectId: "roulette-data-4f5bf",
    storageBucket: "roulette-data-4f5bf.app",
    messagingSenderId: "282079852816",
    appId: "1:282079852816:web:c02c711169a47bf9230d95",
    databaseURL: "https://roulette-data-4f5bf-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
signInAnonymously(auth).catch(console.error);

const db = getDatabase(app);
window.firebaseDB = { db, ref, get, set, update, push, query, limitToLast };
</script>

<style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ */
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@500;700&display=swap');
:root {
    --surface-color: transparent;
    --primary-color: #c792ea;
    --gradient-start: #b39ddb;
    --gradient-end: #8e8dcc;
    --text-color-dark: #2c2c2c;
    --text-color-active: #ffffff;
    --text-color-inactive: #d1c4e9;
    --border-color: #5e5a81;
    --input-bg-color: #2e2a4f;
}
html { font-size: 15px; }
body { font-family: 'Noto Sans KR', sans-serif; background-color: transparent; color: var(--text-color-active); margin:0;padding:0;}
.container { background-color: var(--surface-color); padding: 20px; text-align: center; }
h1 { color: var(--primary-color); margin-top:0;margin-bottom:30px;font-weight:700;font-size:1.8em; }
.slot-machine { display: flex; justify-content: space-around; margin-bottom:25px; gap:20px; }
.role { width:48%; }
.role h2 { font-size:1.1em; color: var(--text-color-inactive); margin-bottom:10px; font-weight:500; }
.slot-window { background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end)); border-radius:10px; height:60px; font-size:1.7em; font-weight:700; overflow:hidden; position:relative; }
.slot-reel { position:absolute; top:0; left:0; right:0; transition:none; }
.reel-item { height:60px; display:flex; align-items:center; justify-content:center; }
.reel-item.active { color: var(--text-color-active); }
#spin-button { background-color: var(--primary-color); color: var(--text-color-active); border:none; padding:12px 25px; font-size:1.1em; font-weight:700; border-radius:8px; cursor:pointer; transition:all 0.3s ease; width:100%; }
#spin-button:hover:not(:disabled) { background-color: #d09ff0; }
#spin-button:disabled { background-color: var(--border-color); cursor:not-allowed; opacity:0.7; }
.password-wrapper { margin-top:15px;margin-bottom:25px; }
#admin-password { background-color: var(--input-bg-color); border:1px solid var(--border-color); color: var(--text-color-active); border-radius:6px; padding:8px 12px; text-align:center; width:150px; font-size:1em; font-family:inherit; }
#admin-password:focus { outline:none; border-color: var(--primary-color); }
.shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
@keyframes shake { 10%,90%{transform:translate3d(-1px,0,0);} 20%,80%{transform:translate3d(2px,0,0);} 30%,50%,70%{transform:translate3d(-4px,0,0);} 40%,60%{transform:translate3d(4px,0,0);} }
.candidate-info-wrapper { display:flex; justify-content:space-around; gap:15px; }
.candidate-info { background-color:transparent; padding:0; width:48%; flex-direction:column; }
.candidate-info h3 { margin:0 0 8px 0; color: var(--text-color-inactive); font-size:0.9em; font-weight:500; text-align:left;}
.candidate-list { display:flex; flex-wrap:wrap; gap:8px; min-height:35px; margin:0; padding:0; }
.candidate-tag { padding:6px 12px; margin:0; border-radius:15px; font-size:0.95em; font-weight:700; color: var(--text-color-dark); transition: opacity 0.5s ease-out, transform 0.5s ease-out, margin-right 0.5s ease-in-out; }
</style>
</head>

<body>
<div class="container">
<h1>ì´ë²ˆ ì£¼ ìŠ¤í„°ë”” ë‹¹ë²ˆ ë½‘ê¸° ğŸ°</h1>
<div class="slot-machine">
    <div class="role">
        <h2>ğŸ‘‘ ë¦¬ë”</h2>
        <div class="slot-window"><div id="leader-reel" class="slot-reel"></div></div>
    </div>
    <div class="role">
        <h2>âœï¸ ë…¸íŠ¸ í…Œì´ì»¤</h2>
        <div class="slot-window"><div id="notetaker-reel" class="slot-reel"></div></div>
    </div>
</div>
<button id="spin-button">SPIN!</button>
<div class="password-wrapper">
    <input type="password" id="admin-password" placeholder="Admin Password">
</div>
<div class="candidate-info-wrapper">
    <div class="candidate-info">
        <h3>ë‚¨ì€ ë¦¬ë” í›„ë³´</h3>
        <div id="leader-candidate-list" class="candidate-list"></div>
    </div>
    <div class="candidate-info">
        <h3>ë‚¨ì€ ë…¸íŠ¸ í…Œì´ì»¤ í›„ë³´</h3>
        <div id="notetaker-candidate-list" class="candidate-list"></div>
    </div>
</div>

<script type="module">
document.addEventListener('DOMContentLoaded', () => {
    const ALL_LEADERS = ['ê¹€ì„±ì›','ê¹€ëª…ì„','ë°•ì§€ì›'];
    const ALL_NOTE_TAKERS = ['ê¹€ì„±ì›','ê¹€ëª…ì„','ë°•ì§€ì›'];
    const ADMIN_PASSWORD = '0503';
    const REEL_ITEM_HEIGHT = 60;
    const REEL_REPEAT_COUNT = 5;
    const PASTEL_COLORS = ['#ffadad','#ffd6a5','#fdffb6','#caffbf','#9bf6ff','#a0c4ff','#bdb2ff','#ffc6ff'];

    const UIElements = {
        leaderReel: document.getElementById('leader-reel'),
        notetakerReel: document.getElementById('notetaker-reel'),
        spinButton: document.getElementById('spin-button'),
        leaderCandidateDisplay: document.getElementById('leader-candidate-list'),
        notetakerCandidateDisplay: document.getElementById('notetaker-candidate-list'),
        passwordInput: document.getElementById('admin-password'),
    };

    let state = {
        availableLeaders: [],
        availableNoteTakers: [],
        lastLeader: null,
        lastNoteTaker: null
    };

    async function loadDataFromFirebase() {
        const { db, ref, get, set, query, limitToLast } = window.firebaseDB;
        const dbRef = ref(db, 'studyRoles');

        try {
            const snapshot = await get(dbRef);
            console.log("Firebase snapshot:", snapshot.val());
            let data = snapshot.val();
            
            if (!data) {
                data = {
                    availableLeaders: [...ALL_LEADERS],
                    availableNoteTakers: [...ALL_NOTE_TAKERS],
                    results: {}
                };
                await set(dbRef, data);
            }

            state.availableLeaders = data.availableLeaders || [...ALL_LEADERS];
            state.availableNoteTakers = data.availableNoteTakers || [...ALL_NOTE_TAKERS];

            // ë§ˆì§€ë§‰ ë‹¹ì²¨ì
            const resultsRef = ref(db, 'studyRoles/results');
            const lastResultQuery = query(resultsRef, limitToLast(1));
            const resultSnapshot = await get(lastResultQuery);
            if (resultSnapshot.exists()) {
                const resultsData = resultSnapshot.val();
                const lastKey = Object.keys(resultsData)[0];
                const lastResult = resultsData[lastKey];
                state.lastLeader = lastResult.leader;
                state.lastNoteTaker = lastResult.noteTaker;
            }

        } catch(err) {
            console.error("Firebase ë¡œë“œ ì—ëŸ¬:", err);
            state.availableLeaders = [...ALL_LEADERS];
            state.availableNoteTakers = [...ALL_NOTE_TAKERS];
        }

        // UI í‘œì‹œ
        displayCandidates(UIElements.leaderCandidateDisplay, state.availableLeaders);
        displayCandidates(UIElements.notetakerCandidateDisplay, state.availableNoteTakers);
        setupInitialReels();
    }

    async function updateFirebaseData(newLeaderList, newNoteTakerList, winnerLeader, winnerNoteTaker) {
        const { db, ref, update, push } = window.firebaseDB;
        const dbRef = ref(db, 'studyRoles');
        const resultsRef = ref(db, 'studyRoles/results');

        const newResult = {
            leader: winnerLeader,
            noteTaker: winnerNoteTaker,
            timestamp: new Date().toISOString()
        };

        try {
            await update(dbRef, {
                availableLeaders: newLeaderList,
                availableNoteTakers: newNoteTakerList
            });
            await push(resultsRef, newResult);
        } catch(err) { console.error("Firebase ì—…ë°ì´íŠ¸ ì—ëŸ¬:", err); }
    }

    function displayCandidates(container, names) {
        container.innerHTML = '';
        const shuffledColors = [...PASTEL_COLORS].sort(() => 0.5 - Math.random());
        names.forEach((name, index) => {
            const tag = document.createElement('span');
            tag.className = 'candidate-tag';
            tag.textContent = name;
            tag.dataset.name = name;
            tag.style.backgroundColor = shuffledColors[index % shuffledColors.length];
            container.appendChild(tag);
        });
    }

    function setupReel(reelElement, candidates, initialWinner=null) {
        reelElement.innerHTML = '';
        if(candidates.length===0 && !initialWinner) return [];
        let displayCands = [...candidates];
        if(initialWinner && !displayCands.includes(initialWinner)) displayCands.push(initialWinner);
        if(displayCands.length===0) return [];
        const shuffled = displayCands.sort(() => Math.random()-0.5);
        const extended = Array(REEL_REPEAT_COUNT).fill(shuffled).flat();
        extended.forEach(name=>{
            const div = document.createElement('div');
            div.className='reel-item';
            div.textContent=name;
            reelElement.appendChild(div);
        });
        return extended;
    }

    function setupInitialReels() {
        const leaderReelItems = setupReel(UIElements.leaderReel, state.availableLeaders, state.lastLeader);
        if(leaderReelItems.length>0){
            const winner = state.lastLeader || leaderReelItems[0];
            const winnerIndex = leaderReelItems.indexOf(winner);
            UIElements.leaderReel.style.top = `-${winnerIndex*REEL_ITEM_HEIGHT}px`;
            UIElements.leaderReel.children[winnerIndex]?.classList.add('active');
        }
        const notetakerReelItems = setupReel(UIElements.notetakerReel, state.availableNoteTakers, state.lastNoteTaker);
        if(notetakerReelItems.length>0){
            const winner = state.lastNoteTaker || notetakerReelItems[0];
            const winnerIndex = notetakerReelItems.indexOf(winner);
            UIElements.notetakerReel.style.top = `-${winnerIndex*REEL_ITEM_HEIGHT}px`;
            UIElements.notetakerReel.children[winnerIndex]?.classList.add('active');
        }
    }

    function runSpin(reelElement, fullReel, winner) {
        return new Promise(resolve=>{
            const winnerBaseIndex = fullReel.lastIndexOf(winner);
            const targetTop = -winnerBaseIndex*REEL_ITEM_HEIGHT;
            const spinDuration = 3000 + Math.random()*1000;
            Array.from(reelElement.children).forEach(c=>c.classList.remove('active'));
            reelElement.children[winnerBaseIndex]?.classList.add('active');
            reelElement.style.transition=`top ${spinDuration}ms cubic-bezier(0.25,0.1,0.25,1)`;
            reelElement.style.top=`${targetTop}px`;
            reelElement.addEventListener('transitionend', ()=>resolve(), {once:true});
        });
    }

    function checkPassword() {
        if(UIElements.passwordInput.value!==ADMIN_PASSWORD){
            UIElements.passwordInput.classList.add('shake');
            setTimeout(()=>UIElements.passwordInput.classList.remove('shake'),500);
            return false;
        }
        return true;
    }

    async function selectRoles(){
        if(!checkPassword()) return;
        UIElements.spinButton.disabled=true;

        if(state.availableLeaders.length===0){
            state.availableLeaders=[...ALL_LEADERS];
            displayCandidates(UIElements.leaderCandidateDisplay,state.availableLeaders);
        }
        let tempNoteTakerCandidates = [...state.availableNoteTakers];
        if(tempNoteTakerCandidates.length===0){
            tempNoteTakerCandidates=[...ALL_NOTE_TAKERS];
            displayCandidates(UIElements.notetakerCandidateDisplay,tempNoteTakerCandidates);
        }

        const finalLeader = state.availableLeaders[Math.floor(Math.random()*state.availableLeaders.length)];
        let validNoteTakerCandidates = tempNoteTakerCandidates.filter(n=>n!==finalLeader);
        if(validNoteTakerCandidates.length===0){
            tempNoteTakerCandidates=[...ALL_NOTE_TAKERS];
            validNoteTakerCandidates = tempNoteTakerCandidates.filter(n=>n!==finalLeader);
            displayCandidates(UIElements.notetakerCandidateDisplay,tempNoteTakerCandidates);
        }
        const finalNoteTaker = validNoteTakerCandidates[Math.floor(Math.random()*validNoteTakerCandidates.length)];

        const leaderReelItems = setupReel(UIElements.leaderReel, state.availableLeaders);
        const notetakerReelItems = setupReel(UIElements.notetakerReel, tempNoteTakerCandidates);
        await new Promise(requestAnimationFrame);
        await Promise.all([
            runSpin(UIElements.leaderReel, leaderReelItems, finalLeader),
            runSpin(UIElements.notetakerReel, notetakerReelItems, finalNoteTaker),
        ]);
        await new Promise(r=>setTimeout(r,1000));
        state.availableLeaders = state.availableLeaders.filter(n=>n!==finalLeader);
        state.availableNoteTakers = tempNoteTakerCandidates.filter(n=>n!==finalNoteTaker);
        displayCandidates(UIElements.leaderCandidateDisplay,state.availableLeaders);
        displayCandidates(UIElements.notetakerCandidateDisplay,state.availableNoteTakers);
        await updateFirebaseData(state.availableLeaders,state.availableNoteTakers,finalLeader,finalNoteTaker);
        UIElements.spinButton.disabled=false;
    }

    UIElements.spinButton.addEventListener('click', selectRoles);
    loadDataFromFirebase();
});
</script>

</body>
</html>
